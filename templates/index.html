<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Bank Dashboard</title>
    <style>
        :root, [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-sidebar: #1e293b;
            --text-primary: #1a1a2e;
            --text-secondary: #64748b;
            --text-sidebar: #94a3b8;
            --text-sidebar-active: #ffffff;
            --border-color: #e2e8f0;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --sidebar-active-bg: rgba(59, 130, 246, 0.2);
            --code-bg: #f1f5f9;
            --table-stripe: #f8fafc;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-sidebar: #0c1222;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-sidebar: #64748b;
            --text-sidebar-active: #e2e8f0;
            --border-color: #334155;
            --accent: #60a5fa;
            --accent-hover: #3b82f6;
            --sidebar-active-bg: rgba(96, 165, 250, 0.15);
            --code-bg: #1e293b;
            --table-stripe: #1e293b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.65rem 1.5rem;
            background: var(--bg-sidebar);
            color: #e2e8f0;
            flex-shrink: 0;
            z-index: 10;
        }

        .header h1 { font-size: 1.1rem; font-weight: 600; letter-spacing: -0.01em; }

        .header-left { display: flex; align-items: center; gap: 0.75rem; }

        .header-version {
            font-size: 0.65rem;
            color: #64748b;
            font-family: 'SF Mono', 'Fira Code', monospace;
            background: rgba(255,255,255,0.06);
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
        }

        .header-actions { display: flex; gap: 0.5rem; }

        .header-btn {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            color: #cbd5e1;
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.15s, color 0.15s;
        }

        .header-btn:hover { background: rgba(255,255,255,0.15); color: #fff; }

        .color-picker-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .color-picker-label {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            color: #cbd5e1;
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.15s, color 0.15s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .color-picker-label:hover { background: rgba(255,255,255,0.15); color: #fff; }

        .color-picker-swatch {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            display: inline-block;
            transition: background-color 0.15s;
        }

        #accent-picker, #bg-picker {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
            pointer-events: none;
        }

        .app-container { display: flex; flex: 1; overflow: hidden; }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: var(--bg-sidebar);
            overflow-y: auto;
            flex-shrink: 0;
            padding: 0.75rem 0;
            border-right: 1px solid rgba(255,255,255,0.06);
        }

        .sidebar-section { border-bottom: 1px solid rgba(255,255,255,0.06); }
        .sidebar-section:last-child { border-bottom: none; }

        .sidebar-heading {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.55rem 1rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #cbd5e1;
            font-weight: 700;
            cursor: pointer;
            user-select: none;
            transition: background 0.15s, color 0.15s;
            border-radius: 4px;
            margin: 0.15rem 0.5rem;
        }

        .sidebar-heading:hover { background: rgba(255,255,255,0.08); color: #ffffff; }

        .sidebar-chevron {
            font-size: 0.85rem;
            transition: transform 0.2s ease;
            display: inline-block;
            color: #94a3b8;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }

        .sidebar-heading:hover .sidebar-chevron { color: #ffffff; }

        .sidebar-section.collapsed .sidebar-chevron { transform: rotate(-90deg); }
        .sidebar-section.collapsed .sidebar-body { display: none; }

        .sidebar-body { padding-bottom: 0.25rem; }

        .sidebar-item {
            display: block;
            padding: 0.5rem 1.25rem;
            color: var(--text-sidebar);
            cursor: pointer;
            transition: background 0.12s, color 0.12s;
            font-size: 0.85rem;
            border-left: 3px solid transparent;
            user-select: none;
        }

        .sidebar-item:hover {
            background: var(--sidebar-active-bg);
            color: var(--text-sidebar-active);
        }

        .sidebar-item.active {
            background: var(--sidebar-active-bg);
            color: var(--text-sidebar-active);
            border-left-color: var(--accent);
            font-weight: 600;
        }

        .sidebar-item.sub-item { padding-left: 2rem; font-size: 0.8rem; }

        .sidebar-empty {
            padding: 0.4rem 2rem;
            font-size: 0.75rem;
            color: var(--text-sidebar);
            font-style: italic;
            opacity: 0.6;
        }

        .sidebar-count {
            font-size: 0.65rem;
            background: rgba(255,255,255,0.12);
            color: #94a3b8;
            padding: 0.1rem 0.45rem;
            border-radius: 8px;
            margin-left: 0.4rem;
            font-weight: 500;
        }

        /* Content */
        .content { flex: 1; overflow-y: auto; padding: 2rem 3rem; }
        .content-inner { max-width: 860px; }

        .content-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 1.25rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .breadcrumb { font-size: 0.82rem; color: var(--text-secondary); margin-bottom: 1rem; }
        .breadcrumb a { color: var(--accent); text-decoration: none; }
        .breadcrumb a:hover { text-decoration: underline; }

        .loading { color: var(--text-secondary); font-style: italic; padding: 2rem 0; }

        .error {
            color: #ef4444;
            padding: 1rem;
            background: rgba(239,68,68,0.08);
            border-radius: 8px;
            border: 1px solid rgba(239,68,68,0.2);
        }

        /* Markdown body */
        .markdown-body h1 {
            font-size: 1.65rem; margin: 0 0 0.75rem; padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color); font-weight: 700;
        }
        .markdown-body h2 { font-size: 1.25rem; margin: 1.75rem 0 0.6rem; color: var(--accent); font-weight: 600; }
        .markdown-body h3 { font-size: 1.05rem; margin: 1.25rem 0 0.5rem; font-weight: 600; }
        .markdown-body p { margin: 0.5rem 0; line-height: 1.7; }
        .markdown-body ul, .markdown-body ol { padding-left: 1.5rem; margin: 0.5rem 0; }
        .markdown-body li { margin: 0.2rem 0; line-height: 1.65; }
        .markdown-body strong { font-weight: 600; }
        .markdown-body code {
            background: var(--code-bg); padding: 0.15em 0.4em; border-radius: 4px;
            font-size: 0.88em; font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
        }
        .markdown-body pre {
            background: var(--code-bg); padding: 1rem; border-radius: 8px;
            overflow-x: auto; margin: 1rem 0; border: 1px solid var(--border-color);
        }
        .markdown-body pre code { background: none; padding: 0; font-size: 0.85em; }
        .markdown-body table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.88rem; }
        .markdown-body th {
            background: var(--bg-secondary); font-weight: 600; text-align: left;
            padding: 0.55rem 0.75rem; border: 1px solid var(--border-color);
        }
        .markdown-body td { padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); }
        .markdown-body tr:nth-child(even) { background: var(--table-stripe); }
        .markdown-body blockquote {
            border-left: 4px solid var(--accent); padding: 0.5rem 1rem; margin: 1rem 0;
            background: var(--bg-secondary); border-radius: 0 6px 6px 0; color: var(--text-secondary);
        }
        .markdown-body hr { border: none; border-top: 1px solid var(--border-color); margin: 1.5rem 0; }
        .markdown-body a { color: var(--accent); text-decoration: none; }
        .markdown-body a:hover { text-decoration: underline; }
        .markdown-body input[type="checkbox"] { margin-right: 0.4rem; accent-color: var(--accent); }

        .task-link { color: var(--accent) !important; cursor: pointer; font-weight: 600; }
        .task-link:hover { text-decoration: underline !important; }

        /* Dashboard */
        .dashboard { max-width: 900px; }

        .dashboard-banner {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 1rem;
        }

        .dashboard-banner h2 {
            font-size: 1rem;
            margin: 0 0 0.4rem;
            color: var(--accent);
            font-weight: 700;
        }

        .dashboard-banner p {
            font-size: 0.88rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin: 0;
        }

        .dashboard-banner .focus-text {
            margin-top: 0.35rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .dashboard-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1.15rem 1.35rem;
        }

        .dashboard-card h3 {
            font-size: 0.72rem;
            margin: 0 0 0.65rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .dashboard-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.3rem 0.4rem;
            font-size: 0.88rem;
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 4px;
        }

        .dashboard-row:hover { background: var(--sidebar-active-bg); }

        .dashboard-row .label { flex: 1; display: flex; align-items: center; }
        .dashboard-row .count {
            font-weight: 700;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.82rem;
            color: var(--accent);
        }

        .bar-track {
            background: var(--border-color);
            border-radius: 6px;
            height: 7px;
            margin: 0.25rem 0 0.45rem;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.4s ease;
        }

        .bar-green { background: #22c55e; }
        .bar-amber { background: #f59e0b; }
        .bar-accent { background: var(--accent); }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
            flex-shrink: 0;
        }

        .dot-green { background: #22c55e; }
        .dot-blue { background: #3b82f6; }
        .dot-gray { background: #94a3b8; }
        .dot-red { background: #ef4444; }

        .dbadge {
            display: inline-block;
            padding: 0.1rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .dbadge-green { background: rgba(34,197,94,0.15); color: #22c55e; }
        .dbadge-red { background: rgba(239,68,68,0.15); color: #ef4444; }

        .dashboard-steps {
            padding-left: 1.15rem;
            margin: 0;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .dashboard-steps li { margin-bottom: 0.25rem; line-height: 1.5; }

        .recent-table { width: 100%; font-size: 0.85rem; border-collapse: collapse; }
        .recent-table tr { cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .recent-table tr:last-child { border-bottom: none; }
        .recent-table tr:hover { background: var(--sidebar-active-bg); }
        .recent-table td { padding: 0.4rem 0.5rem; }

        .source-tag {
            font-size: 0.68rem;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            background: rgba(59,130,246,0.12);
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-weight: 600;
        }

        @media (max-width: 700px) {
            .dashboard-grid { grid-template-columns: 1fr; }
        }

        /* Notes Feed */
        .notes-feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-color);
        }

        .notes-feed-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .notes-feed-controls {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .notes-feed-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-right: 0.25rem;
        }

        .notes-count-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.3rem 0.65rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: background 0.15s, color 0.15s, border-color 0.15s;
        }

        .notes-count-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .notes-count-btn.active {
            background: var(--accent);
            color: #ffffff;
            border-color: var(--accent);
        }

        .notes-feed-showing {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-left: 0.5rem;
        }

        .note-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 1rem;
        }

        .note-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .note-card-title {
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--accent);
            margin: 0;
            cursor: pointer;
        }

        .note-card-title:hover { text-decoration: underline; }

        .note-card-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            flex-shrink: 0;
            margin-left: 1rem;
        }

        .note-card-body { font-size: 0.92rem; }
        .note-card-body h1 { display: none; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <h1>Memory Bank</h1>
            <span class="header-version">{{ version }}</span>
        </div>
        <div class="header-actions">
            <button class="header-btn" id="refresh-btn" title="Reload files">Refresh</button>
            <div class="color-picker-wrapper">
                <label class="color-picker-label" for="accent-picker" title="Choose accent color">
                    <span class="color-picker-swatch" id="color-swatch"></span>
                    Accent
                </label>
                <input type="color" id="accent-picker" value="#3b82f6">
            </div>
            <div class="color-picker-wrapper">
                <label class="color-picker-label" for="bg-picker" title="Choose background color">
                    <span class="color-picker-swatch" id="bg-swatch"></span>
                    Background
                </label>
                <input type="color" id="bg-picker" value="#ffffff">
            </div>
            <button class="header-btn" id="theme-btn" title="Reset all colors to defaults">Reset</button>
        </div>
    </header>
    <div class="app-container">
        <nav class="sidebar" id="sidebar"></nav>
        <main class="content">
            <div class="content-inner">
                <div id="content-meta" class="content-meta" style="display:none;"></div>
                <article class="markdown-body" id="markdown-body">
                    <div class="loading">Select a file from the sidebar.</div>
                </article>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked@14/marked.min.js"></script>
    <script>
        // --- State ---
        const state = {
            currentFile: null,
            currentSource: null,
            showDashboard: true,
            dashboardData: null,
            files: [], tasks: [], lessons: [], adrs: [], features: [], notes: [],
            hasLessonIndex: false, hasAdrIndex: false,
            showNotesFeed: false,
            notesFeedCount: parseInt(localStorage.getItem('mb-notes-count')) || 5,
            theme: localStorage.getItem('mb-theme') || 'light',
        };

        // --- Collapsed sections (persisted) ---
        function getCollapsed() {
            try { return JSON.parse(localStorage.getItem('mb-collapsed') || '{}'); } catch(e) { return {}; }
        }
        function setCollapsed(id, val) {
            var c = getCollapsed(); c[id] = val; localStorage.setItem('mb-collapsed', JSON.stringify(c));
        }
        function isCollapsed(id) { return getCollapsed()[id] === true; }

        // --- Accent Color ---
        var defaultAccents = { light: '#3b82f6', dark: '#60a5fa' };
        var defaultBgs = { light: '#ffffff', dark: '#0f172a' };

        function hexToRgb(hex) {
            var r = parseInt(hex.slice(1, 3), 16);
            var g = parseInt(hex.slice(3, 5), 16);
            var b = parseInt(hex.slice(5, 7), 16);
            return { r: r, g: g, b: b };
        }

        function rgbToHex(r, g, b) {
            return '#' + [r, g, b].map(function(c) {
                return Math.max(0, Math.min(255, Math.round(c))).toString(16).padStart(2, '0');
            }).join('');
        }

        function darkenHex(hex, amount) {
            var rgb = hexToRgb(hex);
            return rgbToHex(rgb.r * (1 - amount), rgb.g * (1 - amount), rgb.b * (1 - amount));
        }

        function lightenHex(hex, amount) {
            var rgb = hexToRgb(hex);
            return rgbToHex(
                rgb.r + (255 - rgb.r) * amount,
                rgb.g + (255 - rgb.g) * amount,
                rgb.b + (255 - rgb.b) * amount
            );
        }

        function luminance(hex) {
            var rgb = hexToRgb(hex);
            var srgb = [rgb.r, rgb.g, rgb.b].map(function(c) {
                c = c / 255;
                return c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
            });
            return 0.2126 * srgb[0] + 0.7152 * srgb[1] + 0.0722 * srgb[2];
        }

        function applyAccentColor(hex) {
            var rgb = hexToRgb(hex);
            var root = document.documentElement;
            root.style.setProperty('--accent', hex);
            root.style.setProperty('--accent-hover', darkenHex(hex, 0.2));
            root.style.setProperty('--sidebar-active-bg', 'rgba(' + rgb.r + ',' + rgb.g + ',' + rgb.b + ',0.2)');
            document.getElementById('accent-picker').value = hex;
            document.getElementById('color-swatch').style.backgroundColor = hex;
        }

        function applyBgColor(hex) {
            var root = document.documentElement;
            var isLight = luminance(hex) > 0.4;

            root.style.setProperty('--bg-primary', hex);
            root.style.setProperty('--bg-secondary', isLight ? darkenHex(hex, 0.03) : lightenHex(hex, 0.06));
            root.style.setProperty('--code-bg', isLight ? darkenHex(hex, 0.05) : lightenHex(hex, 0.08));
            root.style.setProperty('--table-stripe', isLight ? darkenHex(hex, 0.02) : lightenHex(hex, 0.04));
            root.style.setProperty('--border-color', isLight ? darkenHex(hex, 0.12) : lightenHex(hex, 0.15));
            root.style.setProperty('--text-primary', isLight ? '#1a1a2e' : '#e2e8f0');
            root.style.setProperty('--text-secondary', isLight ? '#64748b' : '#94a3b8');
            root.style.setProperty('--bg-sidebar', isLight ? darkenHex(hex, 0.85) : darkenHex(hex, 0.4));
            root.style.setProperty('--text-sidebar', '#94a3b8');
            root.style.setProperty('--text-sidebar-active', isLight ? '#ffffff' : '#e2e8f0');

            document.getElementById('bg-picker').value = hex;
            document.getElementById('bg-swatch').style.backgroundColor = hex;
        }

        function getSavedAccent() {
            return localStorage.getItem('mb-accent') || null;
        }

        function getSavedBg() {
            return localStorage.getItem('mb-bg') || null;
        }

        // --- Init ---
        async function init() {
            applyTheme(state.theme);
            var savedBg = getSavedBg();
            if (savedBg) {
                applyBgColor(savedBg);
            } else {
                applyBgColor(defaultBgs[state.theme]);
            }
            var savedAccent = getSavedAccent();
            if (savedAccent) {
                applyAccentColor(savedAccent);
            } else {
                applyAccentColor(defaultAccents[state.theme]);
            }
            marked.setOptions({ gfm: true, breaks: false });
            await loadManifest();
            buildSidebar();
            showDashboard();
        }
        document.addEventListener('DOMContentLoaded', init);

        // --- API ---
        async function loadManifest() {
            const [filesRes, tasksRes, lessonsRes, adrsRes, featuresRes, notesRes] = await Promise.all([
                fetch('/api/files').then(function(r) { return r.json(); }),
                fetch('/api/tasks').then(function(r) { return r.json(); }),
                fetch('/api/lessons').then(function(r) { return r.json(); }),
                fetch('/api/adrs').then(function(r) { return r.json(); }),
                fetch('/api/features').then(function(r) { return r.json(); }),
                fetch('/api/notes').then(function(r) { return r.json(); }),
            ]);
            state.files = filesRes.files;
            state.tasks = tasksRes.tasks;
            state.lessons = lessonsRes.lessons;
            state.hasLessonIndex = lessonsRes.has_index;
            state.adrs = adrsRes.adrs;
            state.hasAdrIndex = adrsRes.has_index;
            state.features = featuresRes.features;
            state.notes = notesRes.notes;
        }

        // --- Source-to-API mapping ---
        var sourceApiMap = {
            'memory-bank': '/api/file/',
            'lesson': '/api/lesson/',
            'adr': '/api/adr/',
            'feature': '/api/feature/',
            'note': '/api/note/',
        };

        var sourceLabel = {
            'memory-bank': '',
            'lesson': 'lessons-learned/',
            'adr': 'adrs/',
            'feature': 'features/',
            'note': 'notes/',
        };

        async function loadFile(filename, source) {
            state.showDashboard = false;
            state.showNotesFeed = false;
            source = source || 'memory-bank';
            state.currentFile = filename;
            state.currentSource = source;
            updateActiveState();

            var body = document.getElementById('markdown-body');
            var meta = document.getElementById('content-meta');
            body.innerHTML = '<div class="loading">Loading...</div>';
            meta.style.display = 'none';

            try {
                var url = sourceApiMap[source] + encodeURIComponent(filename);
                var res = await fetch(url);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                var data = await res.json();

                body.innerHTML = marked.parse(data.content);

                var date = new Date(data.modified * 1000);
                meta.textContent = sourceLabel[source] + filename + '  \u2014  last modified ' + date.toLocaleString();
                meta.style.display = 'block';

                // Breadcrumb for task detail pages
                if (source === 'memory-bank' && filename.startsWith('tasks/') && filename !== 'tasks/_index.md') {
                    addBreadcrumb(body, 'Tasks Index', function() { loadFile('tasks/_index.md'); },
                        filename.split('/').pop().replace('.md', ''));
                }

                // Breadcrumb for lesson detail pages
                if (source === 'lesson' && filename !== 'lesson-learned-index.md') {
                    if (state.hasLessonIndex) {
                        addBreadcrumb(body, 'Lessons Index', function() { loadFile('lesson-learned-index.md', 'lesson'); },
                            filename.replace('.md', ''));
                    } else {
                        addBreadcrumb(body, null, null, filename.replace('.md', ''), 'Lessons Learned');
                    }
                }

                // Breadcrumb for ADR detail pages
                if (source === 'adr' && filename !== 'README.md') {
                    if (state.hasAdrIndex) {
                        addBreadcrumb(body, 'ADR Index', function() { loadFile('README.md', 'adr'); },
                            filename.replace('.md', ''));
                    } else {
                        addBreadcrumb(body, null, null, filename.replace('.md', ''), 'ADRs');
                    }
                }

                // Breadcrumb for note detail pages
                if (source === 'note') {
                    addBreadcrumb(body, 'Notes Feed', function() { showNotesFeed(); },
                        filename.replace('.md', ''));
                }

                // Linkify references
                if (source === 'memory-bank' && filename === 'tasks/_index.md') linkifyTaskReferences(body);
                if (source === 'lesson' && filename === 'lesson-learned-index.md') linkifyLessonReferences(body);
            } catch (err) {
                body.innerHTML = '<div class="error">Failed to load ' + filename + ': ' + err.message + '</div>';
            }
        }

        function addBreadcrumb(container, linkText, linkClick, suffix, plainPrefix) {
            var bc = document.createElement('div');
            bc.className = 'breadcrumb';
            if (linkText && linkClick) {
                var a = document.createElement('a');
                a.href = '#';
                a.textContent = linkText;
                a.addEventListener('click', function(e) { e.preventDefault(); linkClick(); });
                bc.appendChild(a);
            } else if (plainPrefix) {
                bc.appendChild(document.createTextNode(plainPrefix));
            }
            bc.appendChild(document.createTextNode(' / ' + suffix));
            container.prepend(bc);
        }

        // --- Sidebar ---
        function buildSidebar() {
            var sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = '';

            // Dashboard link
            var dashItem = sidebarItem('\u2302 Dashboard', '__dashboard__', '__dashboard__');
            dashItem.addEventListener('click', function(e) { e.stopPropagation(); showDashboard(); });
            dashItem.removeEventListener = null; // prevent double-bind
            sidebar.appendChild(dashItem);

            // Core Files
            addSection(sidebar, 'core', 'Core Files', state.files.length, function(body) {
                state.files.forEach(function(f) {
                    body.appendChild(sidebarItem(f.label, f.filename, 'memory-bank'));
                });
            });

            // Tasks
            addSection(sidebar, 'tasks', 'Tasks', state.tasks.length + 1, function(body) {
                body.appendChild(sidebarItem('Task Index', 'tasks/_index.md', 'memory-bank'));
                state.tasks.forEach(function(t) {
                    body.appendChild(sidebarItem(t.label, t.filename, 'memory-bank', true));
                });
            });

            // Lessons Learned
            var llCount = state.lessons.length + (state.hasLessonIndex ? 1 : 0);
            addSection(sidebar, 'lessons', 'Lessons Learned', llCount, function(body) {
                if (state.hasLessonIndex) {
                    body.appendChild(sidebarItem('Lessons Index', 'lesson-learned-index.md', 'lesson'));
                }
                if (state.lessons.length > 0) {
                    state.lessons.forEach(function(l) {
                        body.appendChild(sidebarItem(l.label, l.filename, 'lesson', true));
                    });
                } else if (!state.hasLessonIndex) {
                    body.appendChild(el('div', 'sidebar-empty', 'No lessons yet'));
                }
            });

            // ADRs
            var adrCount = state.adrs.length + (state.hasAdrIndex ? 1 : 0);
            addSection(sidebar, 'adrs', 'ADRs', adrCount, function(body) {
                if (state.hasAdrIndex) {
                    body.appendChild(sidebarItem('ADR Index', 'README.md', 'adr'));
                }
                if (state.adrs.length > 0) {
                    state.adrs.forEach(function(a) {
                        body.appendChild(sidebarItem(a.label, a.filename, 'adr', true));
                    });
                } else if (!state.hasAdrIndex) {
                    body.appendChild(el('div', 'sidebar-empty', 'No ADRs yet'));
                }
            });

            // Features
            addSection(sidebar, 'features', 'Features', state.features.length, function(body) {
                if (state.features.length > 0) {
                    state.features.forEach(function(f) {
                        body.appendChild(sidebarItem(f.label, f.filename, 'feature', true));
                    });
                } else {
                    body.appendChild(el('div', 'sidebar-empty', 'No features yet'));
                }
            });

            // Notes
            addSection(sidebar, 'notes', 'Notes', state.notes.length, function(body) {
                // Notes Feed link at top
                var feedItem = el('div', 'sidebar-item', 'Notes Feed');
                feedItem.dataset.filename = '__notes_feed__';
                feedItem.dataset.source = '__notes_feed__';
                feedItem.addEventListener('click', function() { showNotesFeed(); });
                body.appendChild(feedItem);

                if (state.notes.length > 0) {
                    state.notes.forEach(function(n) {
                        body.appendChild(sidebarItem(n.label, n.filename, 'note', true));
                    });
                } else {
                    body.appendChild(el('div', 'sidebar-empty', 'No notes yet'));
                }
            });
        }

        function addSection(sidebar, id, label, count, buildBody) {
            var section = el('div', 'sidebar-section');
            if (isCollapsed(id)) section.classList.add('collapsed');

            // Heading with chevron and count
            var heading = el('div', 'sidebar-heading');
            var labelSpan = document.createElement('span');
            labelSpan.textContent = label;
            if (count > 0) {
                var badge = el('span', 'sidebar-count', String(count));
                labelSpan.appendChild(badge);
            }
            heading.appendChild(labelSpan);
            var chevron = el('span', 'sidebar-chevron', '\u25BE');
            heading.appendChild(chevron);

            heading.addEventListener('click', function() {
                var nowCollapsed = !section.classList.contains('collapsed');
                section.classList.toggle('collapsed');
                setCollapsed(id, nowCollapsed);
            });

            section.appendChild(heading);

            var body = el('div', 'sidebar-body');
            buildBody(body);
            section.appendChild(body);

            sidebar.appendChild(section);
        }

        function sidebarItem(label, filename, source, isSub) {
            var cls = 'sidebar-item' + (isSub ? ' sub-item' : '');
            var item = el('div', cls, label);
            item.dataset.filename = filename;
            item.dataset.source = source;
            item.addEventListener('click', function() { loadFile(filename, source); });
            return item;
        }

        function updateActiveState() {
            document.querySelectorAll('.sidebar-item').forEach(function(item) {
                item.classList.toggle('active',
                    item.dataset.filename === state.currentFile &&
                    item.dataset.source === state.currentSource
                );
            });
        }

        // --- Task linkification ---
        function linkifyTaskReferences(container) {
            var walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
            var nodes = [];
            while (walker.nextNode()) {
                if (/\[TASK\d+\]/.test(walker.currentNode.textContent)) nodes.push(walker.currentNode);
            }
            nodes.forEach(function(node) {
                var html = node.textContent.replace(/\[(TASK\d+)\]/g, function(match, taskId) {
                    var taskFile = state.tasks.find(function(t) { return t.filename.toUpperCase().includes(taskId); });
                    if (taskFile) return '<a href="#" class="task-link" data-filename="' + taskFile.filename + '" data-source="memory-bank">' + match + '</a>';
                    return match;
                });
                var span = document.createElement('span');
                span.innerHTML = html;
                node.parentNode.replaceChild(span, node);
            });
            container.querySelectorAll('.task-link[data-source="memory-bank"]').forEach(function(link) {
                link.addEventListener('click', function(e) { e.preventDefault(); loadFile(link.dataset.filename); });
            });
        }

        // --- Lesson linkification ---
        function linkifyLessonReferences(container) {
            var walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
            var nodes = [];
            while (walker.nextNode()) {
                if (/LL-\d{3}/.test(walker.currentNode.textContent)) nodes.push(walker.currentNode);
            }
            nodes.forEach(function(node) {
                var html = node.textContent.replace(/\b(LL-\d{3})\b/g, function(match, llId) {
                    var lessonFile = state.lessons.find(function(l) { return l.filename.toUpperCase().startsWith(llId.toUpperCase()); });
                    if (lessonFile) return '<a href="#" class="task-link" data-filename="' + lessonFile.filename + '" data-source="lesson">' + match + '</a>';
                    return match;
                });
                var span = document.createElement('span');
                span.innerHTML = html;
                node.parentNode.replaceChild(span, node);
            });
            container.querySelectorAll('.task-link[data-source="lesson"]').forEach(function(link) {
                link.addEventListener('click', function(e) { e.preventDefault(); loadFile(link.dataset.filename, 'lesson'); });
            });
        }

        // --- Dashboard ---
        async function showDashboard() {
            state.showDashboard = true;
            state.showNotesFeed = false;
            state.currentFile = '__dashboard__';
            state.currentSource = '__dashboard__';
            updateActiveState();

            var body = document.getElementById('markdown-body');
            var meta = document.getElementById('content-meta');
            meta.style.display = 'none';
            body.innerHTML = '<div class="loading">Loading dashboard...</div>';

            try {
                var res = await fetch('/api/dashboard');
                if (!res.ok) throw new Error('HTTP ' + res.status);
                state.dashboardData = await res.json();
                renderDashboard(state.dashboardData);
            } catch (err) {
                body.innerHTML = '<div class="error">Failed to load dashboard: ' + err.message + '</div>';
            }
        }

        function renderDashboard(data) {
            var body = document.getElementById('markdown-body');
            body.innerHTML = '';
            var container = el('div', 'dashboard');

            // Status banner
            var banner = el('div', 'dashboard-banner');
            banner.appendChild(el('h2', '', 'Project Status'));
            banner.appendChild(el('p', '', data.progress.current_status || 'No status available'));
            if (data.active_context.current_focus) {
                var focus = el('p', 'focus-text', 'Focus: ' + data.active_context.current_focus);
                banner.appendChild(focus);
            }
            container.appendChild(banner);

            // Grid
            var grid = el('div', 'dashboard-grid');
            grid.appendChild(buildProgressCard(data.progress));
            grid.appendChild(buildTasksCard(data.tasks));
            grid.appendChild(buildInventoryCard(data.counts));
            grid.appendChild(buildNextStepsCard(data.active_context));
            container.appendChild(grid);

            // Recent files
            container.appendChild(buildRecentCard(data.recent_files));

            body.appendChild(container);
        }

        // --- Notes Feed ---
        async function showNotesFeed(count) {
            count = count || state.notesFeedCount;
            state.notesFeedCount = count;
            localStorage.setItem('mb-notes-count', String(count));
            state.showDashboard = false;
            state.showNotesFeed = true;
            state.currentFile = '__notes_feed__';
            state.currentSource = '__notes_feed__';
            updateActiveState();

            var body = document.getElementById('markdown-body');
            var meta = document.getElementById('content-meta');
            meta.style.display = 'none';
            body.innerHTML = '<div class="loading">Loading notes...</div>';

            try {
                var res = await fetch('/api/notes/recent?count=' + count);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                var data = await res.json();
                renderNotesFeed(data.notes, data.total, count);
            } catch (err) {
                body.innerHTML = '<div class="error">Failed to load notes: ' + err.message + '</div>';
            }
        }

        function renderNotesFeed(notes, total, activeCount) {
            var body = document.getElementById('markdown-body');
            body.innerHTML = '';
            var container = el('div', 'dashboard');

            // Header with title + count selector
            var header = el('div', 'notes-feed-header');
            header.appendChild(el('h2', 'notes-feed-title', 'Notes'));

            var controls = el('div', 'notes-feed-controls');
            controls.appendChild(el('span', 'notes-feed-label', 'Show:'));

            [1, 3, 5, 10].forEach(function(n) {
                var btn = el('button', 'notes-count-btn' + (n === activeCount ? ' active' : ''), String(n));
                btn.addEventListener('click', function() { showNotesFeed(n); });
                controls.appendChild(btn);
            });

            controls.appendChild(el('span', 'notes-feed-showing',
                'Showing ' + notes.length + ' of ' + total));

            header.appendChild(controls);
            container.appendChild(header);

            // Note cards
            if (notes.length === 0) {
                container.appendChild(el('p', 'sidebar-empty', 'No notes found.'));
            } else {
                notes.forEach(function(note) {
                    var card = el('div', 'note-card');

                    var cardHeader = el('div', 'note-card-header');
                    var cardTitle = el('h3', 'note-card-title', note.label);
                    cardTitle.addEventListener('click', function() { loadFile(note.filename, 'note'); });
                    cardHeader.appendChild(cardTitle);
                    cardHeader.appendChild(el('span', 'note-card-time', timeAgo(note.modified)));
                    card.appendChild(cardHeader);

                    var cardBody = el('div', 'note-card-body markdown-body');
                    cardBody.innerHTML = marked.parse(note.content);
                    card.appendChild(cardBody);

                    container.appendChild(card);
                });
            }

            body.appendChild(container);
        }

        function buildProgressCard(p) {
            var card = el('div', 'dashboard-card');
            card.appendChild(el('h3', '', 'Progress'));

            var total = p.what_works + p.whats_left;

            // What Works bar
            var r1 = el('div', 'dashboard-row');
            r1.innerHTML = '<span class="label">What Works</span><span class="count">' + p.what_works + '</span>';
            r1.style.cursor = 'default';
            card.appendChild(r1);
            var t1 = el('div', 'bar-track');
            var f1 = el('div', 'bar-fill bar-green');
            f1.style.width = (total > 0 ? Math.round(100 * p.what_works / total) : 0) + '%';
            t1.appendChild(f1);
            card.appendChild(t1);

            // What's Left bar
            var r2 = el('div', 'dashboard-row');
            r2.innerHTML = '<span class="label">What\'s Left</span><span class="count">' + p.whats_left + '</span>';
            r2.style.cursor = 'default';
            card.appendChild(r2);
            var t2 = el('div', 'bar-track');
            var f2 = el('div', 'bar-fill bar-amber');
            f2.style.width = (total > 0 ? Math.round(100 * p.whats_left / total) : 0) + '%';
            t2.appendChild(f2);
            card.appendChild(t2);

            // Milestones
            var pct = p.milestones_total > 0 ? Math.round(100 * p.milestones_done / p.milestones_total) : 0;
            var r3 = el('div', 'dashboard-row');
            r3.innerHTML = '<span class="label">Milestones</span><span class="count">' + p.milestones_done + '/' + p.milestones_total + '</span>';
            r3.addEventListener('click', function() { loadFile('progress.md'); });
            card.appendChild(r3);
            var t3 = el('div', 'bar-track');
            var f3 = el('div', 'bar-fill bar-accent');
            f3.style.width = pct + '%';
            t3.appendChild(f3);
            card.appendChild(t3);

            // Known Issues
            if (p.known_issues > 0) {
                var r4 = el('div', 'dashboard-row');
                r4.innerHTML = '<span class="label">Known Issues</span><span class="dbadge dbadge-red">' + p.known_issues + '</span>';
                r4.addEventListener('click', function() { loadFile('progress.md'); });
                card.appendChild(r4);
            }

            return card;
        }

        function buildTasksCard(tasks) {
            var card = el('div', 'dashboard-card');
            card.appendChild(el('h3', '', 'Tasks'));

            var statuses = [
                { key: 'in_progress', label: 'In Progress', dot: 'dot-green' },
                { key: 'pending', label: 'Pending', dot: 'dot-blue' },
                { key: 'completed', label: 'Completed', dot: 'dot-gray' },
                { key: 'abandoned', label: 'Abandoned', dot: 'dot-red' },
            ];
            statuses.forEach(function(s) {
                var row = el('div', 'dashboard-row');
                row.innerHTML = '<span class="label"><span class="status-dot ' + s.dot + '"></span>' + s.label + '</span>'
                    + '<span class="count">' + tasks[s.key].length + '</span>';
                row.addEventListener('click', function() { loadFile('tasks/_index.md'); });
                card.appendChild(row);
            });

            return card;
        }

        function buildInventoryCard(counts) {
            var card = el('div', 'dashboard-card');
            card.appendChild(el('h3', '', 'Inventory'));

            var items = [
                { label: 'Core Files', count: counts.core_files + '/' + counts.core_files_total },
                { label: 'Tasks', count: String(counts.tasks) },
                { label: 'Lessons Learned', count: String(counts.lessons) },
                { label: 'ADRs', count: String(counts.adrs) },
                { label: 'Features', count: String(counts.features) },
                { label: 'Notes', count: String(counts.notes) },
            ];
            items.forEach(function(item) {
                var row = el('div', 'dashboard-row');
                row.innerHTML = '<span class="label">' + item.label + '</span><span class="count">' + item.count + '</span>';
                row.style.cursor = 'default';
                card.appendChild(row);
            });

            return card;
        }

        function buildNextStepsCard(ac) {
            var card = el('div', 'dashboard-card');
            card.appendChild(el('h3', '', 'Next Steps & Blockers'));

            if (ac.next_steps.length > 0) {
                var ol = document.createElement('ol');
                ol.className = 'dashboard-steps';
                ac.next_steps.forEach(function(step) {
                    ol.appendChild(el('li', '', step));
                });
                card.appendChild(ol);
            } else {
                card.appendChild(el('p', '', 'No next steps defined'));
            }

            var hr = document.createElement('hr');
            hr.style.cssText = 'border:none;border-top:1px solid var(--border-color);margin:0.65rem 0;';
            card.appendChild(hr);

            if (ac.blockers.length === 0) {
                card.appendChild(el('span', 'dbadge dbadge-green', 'No blockers'));
            } else {
                ac.blockers.forEach(function(b) {
                    var bd = el('div', 'dbadge dbadge-red', b);
                    bd.style.marginBottom = '0.3rem';
                    card.appendChild(bd);
                });
            }

            return card;
        }

        function buildRecentCard(files) {
            var card = el('div', 'dashboard-banner');
            card.appendChild(el('h3', '', 'Recently Modified'));
            if (!files || files.length === 0) {
                card.appendChild(el('p', '', 'No files found'));
                return card;
            }
            var table = document.createElement('table');
            table.className = 'recent-table';
            var sourceNames = { 'memory-bank': 'Core', 'lesson': 'Lesson', 'adr': 'ADR', 'feature': 'Feature', 'note': 'Note' };
            files.forEach(function(f) {
                var tr = document.createElement('tr');
                var tdName = el('td', '', f.name);
                tdName.style.fontWeight = '500';
                var tdSource = document.createElement('td');
                tdSource.innerHTML = '<span class="source-tag">' + (sourceNames[f.source] || f.source) + '</span>';
                var tdTime = el('td', '', timeAgo(f.modified));
                tdTime.style.cssText = 'color:var(--text-secondary);text-align:right;';
                tr.appendChild(tdName);
                tr.appendChild(tdSource);
                tr.appendChild(tdTime);
                tr.addEventListener('click', function() { loadFile(f.filename, f.source); });
                table.appendChild(tr);
            });
            card.appendChild(table);
            return card;
        }

        function timeAgo(epoch) {
            if (!epoch) return 'unknown';
            var seconds = Math.floor(Date.now() / 1000 - epoch);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            return Math.floor(seconds / 86400) + 'd ago';
        }

        // --- Theme ---
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('mb-theme', theme);
        }

        // --- Reset button (toggles light/dark defaults) ---
        document.getElementById('theme-btn').addEventListener('click', function() {
            var target = state.theme === 'light' ? 'dark' : 'light';
            state.theme = target;
            localStorage.removeItem('mb-accent');
            localStorage.removeItem('mb-bg');
            applyTheme(target);
            applyBgColor(defaultBgs[target]);
            applyAccentColor(defaultAccents[target]);
        });

        // --- Accent picker ---
        document.getElementById('accent-picker').addEventListener('input', function(e) {
            applyAccentColor(e.target.value);
            localStorage.setItem('mb-accent', e.target.value);
        });
        document.getElementById('color-swatch').addEventListener('dblclick', function() {
            localStorage.removeItem('mb-accent');
            var bg = getSavedBg() || defaultBgs[state.theme];
            var isLight = luminance(bg) > 0.4;
            applyAccentColor(isLight ? defaultAccents.light : defaultAccents.dark);
        });

        // --- Background picker ---
        document.getElementById('bg-picker').addEventListener('input', function(e) {
            applyBgColor(e.target.value);
            localStorage.setItem('mb-bg', e.target.value);
        });
        document.getElementById('bg-swatch').addEventListener('dblclick', function() {
            localStorage.removeItem('mb-bg');
            applyBgColor(defaultBgs.light);
        });

        // --- Refresh ---
        document.getElementById('refresh-btn').addEventListener('click', async function() {
            await loadManifest();
            buildSidebar();
            if (state.showNotesFeed) {
                showNotesFeed();
            } else if (state.showDashboard) {
                showDashboard();
            } else if (state.currentFile) {
                loadFile(state.currentFile, state.currentSource);
            }
        });

        // --- Auto-refresh (30s) ---
        setInterval(function() {
            if (state.showNotesFeed) {
                showNotesFeed();
            } else if (state.showDashboard) {
                showDashboard();
            } else if (state.currentFile) {
                loadFile(state.currentFile, state.currentSource);
            }
        }, 30000);

        // --- Helpers ---
        function el(tag, className, text) {
            var e = document.createElement(tag);
            if (className) e.className = className;
            if (text) e.textContent = text;
            return e;
        }
    </script>
</body>
</html>
