<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Bank Dashboard</title>
    <style>
        :root, [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-sidebar: #1e293b;
            --text-primary: #1a1a2e;
            --text-secondary: #64748b;
            --text-sidebar: #94a3b8;
            --text-sidebar-active: #ffffff;
            --border-color: #e2e8f0;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --sidebar-active-bg: rgba(59, 130, 246, 0.2);
            --code-bg: #f1f5f9;
            --table-stripe: #f8fafc;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-sidebar: #0c1222;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-sidebar: #64748b;
            --text-sidebar-active: #e2e8f0;
            --border-color: #334155;
            --accent: #60a5fa;
            --accent-hover: #3b82f6;
            --sidebar-active-bg: rgba(96, 165, 250, 0.15);
            --code-bg: #1e293b;
            --table-stripe: #1e293b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.65rem 1.5rem;
            background: var(--bg-sidebar);
            color: #e2e8f0;
            flex-shrink: 0;
            z-index: 10;
        }

        .header h1 { font-size: 1.1rem; font-weight: 600; letter-spacing: -0.01em; }

        .header-actions { display: flex; gap: 0.5rem; }

        .header-btn {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            color: #cbd5e1;
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.15s, color 0.15s;
        }

        .header-btn:hover { background: rgba(255,255,255,0.15); color: #fff; }

        .color-picker-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .color-picker-label {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            color: #cbd5e1;
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.15s, color 0.15s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .color-picker-label:hover { background: rgba(255,255,255,0.15); color: #fff; }

        .color-picker-swatch {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            display: inline-block;
            transition: background-color 0.15s;
        }

        #accent-picker {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
            pointer-events: none;
        }

        .app-container { display: flex; flex: 1; overflow: hidden; }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: var(--bg-sidebar);
            overflow-y: auto;
            flex-shrink: 0;
            padding: 0.75rem 0;
            border-right: 1px solid rgba(255,255,255,0.06);
        }

        .sidebar-section { border-bottom: 1px solid rgba(255,255,255,0.06); }
        .sidebar-section:last-child { border-bottom: none; }

        .sidebar-heading {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.55rem 1rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #cbd5e1;
            font-weight: 700;
            cursor: pointer;
            user-select: none;
            transition: background 0.15s, color 0.15s;
            border-radius: 4px;
            margin: 0.15rem 0.5rem;
        }

        .sidebar-heading:hover { background: rgba(255,255,255,0.08); color: #ffffff; }

        .sidebar-chevron {
            font-size: 0.85rem;
            transition: transform 0.2s ease;
            display: inline-block;
            color: #94a3b8;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }

        .sidebar-heading:hover .sidebar-chevron { color: #ffffff; }

        .sidebar-section.collapsed .sidebar-chevron { transform: rotate(-90deg); }
        .sidebar-section.collapsed .sidebar-body { display: none; }

        .sidebar-body { padding-bottom: 0.25rem; }

        .sidebar-item {
            display: block;
            padding: 0.5rem 1.25rem;
            color: var(--text-sidebar);
            cursor: pointer;
            transition: background 0.12s, color 0.12s;
            font-size: 0.85rem;
            border-left: 3px solid transparent;
            user-select: none;
        }

        .sidebar-item:hover {
            background: var(--sidebar-active-bg);
            color: var(--text-sidebar-active);
        }

        .sidebar-item.active {
            background: var(--sidebar-active-bg);
            color: var(--text-sidebar-active);
            border-left-color: var(--accent);
            font-weight: 600;
        }

        .sidebar-item.sub-item { padding-left: 2rem; font-size: 0.8rem; }

        .sidebar-empty {
            padding: 0.4rem 2rem;
            font-size: 0.75rem;
            color: var(--text-sidebar);
            font-style: italic;
            opacity: 0.6;
        }

        .sidebar-count {
            font-size: 0.65rem;
            background: rgba(255,255,255,0.12);
            color: #94a3b8;
            padding: 0.1rem 0.45rem;
            border-radius: 8px;
            margin-left: 0.4rem;
            font-weight: 500;
        }

        /* Content */
        .content { flex: 1; overflow-y: auto; padding: 2rem 3rem; }
        .content-inner { max-width: 860px; }

        .content-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 1.25rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .breadcrumb { font-size: 0.82rem; color: var(--text-secondary); margin-bottom: 1rem; }
        .breadcrumb a { color: var(--accent); text-decoration: none; }
        .breadcrumb a:hover { text-decoration: underline; }

        .loading { color: var(--text-secondary); font-style: italic; padding: 2rem 0; }

        .error {
            color: #ef4444;
            padding: 1rem;
            background: rgba(239,68,68,0.08);
            border-radius: 8px;
            border: 1px solid rgba(239,68,68,0.2);
        }

        /* Markdown body */
        .markdown-body h1 {
            font-size: 1.65rem; margin: 0 0 0.75rem; padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color); font-weight: 700;
        }
        .markdown-body h2 { font-size: 1.25rem; margin: 1.75rem 0 0.6rem; color: var(--accent); font-weight: 600; }
        .markdown-body h3 { font-size: 1.05rem; margin: 1.25rem 0 0.5rem; font-weight: 600; }
        .markdown-body p { margin: 0.5rem 0; line-height: 1.7; }
        .markdown-body ul, .markdown-body ol { padding-left: 1.5rem; margin: 0.5rem 0; }
        .markdown-body li { margin: 0.2rem 0; line-height: 1.65; }
        .markdown-body strong { font-weight: 600; }
        .markdown-body code {
            background: var(--code-bg); padding: 0.15em 0.4em; border-radius: 4px;
            font-size: 0.88em; font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
        }
        .markdown-body pre {
            background: var(--code-bg); padding: 1rem; border-radius: 8px;
            overflow-x: auto; margin: 1rem 0; border: 1px solid var(--border-color);
        }
        .markdown-body pre code { background: none; padding: 0; font-size: 0.85em; }
        .markdown-body table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.88rem; }
        .markdown-body th {
            background: var(--bg-secondary); font-weight: 600; text-align: left;
            padding: 0.55rem 0.75rem; border: 1px solid var(--border-color);
        }
        .markdown-body td { padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); }
        .markdown-body tr:nth-child(even) { background: var(--table-stripe); }
        .markdown-body blockquote {
            border-left: 4px solid var(--accent); padding: 0.5rem 1rem; margin: 1rem 0;
            background: var(--bg-secondary); border-radius: 0 6px 6px 0; color: var(--text-secondary);
        }
        .markdown-body hr { border: none; border-top: 1px solid var(--border-color); margin: 1.5rem 0; }
        .markdown-body a { color: var(--accent); text-decoration: none; }
        .markdown-body a:hover { text-decoration: underline; }
        .markdown-body input[type="checkbox"] { margin-right: 0.4rem; accent-color: var(--accent); }

        .task-link { color: var(--accent) !important; cursor: pointer; font-weight: 600; }
        .task-link:hover { text-decoration: underline !important; }
    </style>
</head>
<body>
    <header class="header">
        <h1>Memory Bank</h1>
        <div class="header-actions">
            <button class="header-btn" id="refresh-btn" title="Reload files">Refresh</button>
            <div class="color-picker-wrapper">
                <label class="color-picker-label" for="accent-picker" title="Choose accent color">
                    <span class="color-picker-swatch" id="color-swatch"></span>
                    Color
                </label>
                <input type="color" id="accent-picker" value="#3b82f6">
            </div>
            <button class="header-btn" id="theme-btn" title="Toggle dark/light theme">Theme</button>
        </div>
    </header>
    <div class="app-container">
        <nav class="sidebar" id="sidebar"></nav>
        <main class="content">
            <div class="content-inner">
                <div id="content-meta" class="content-meta" style="display:none;"></div>
                <article class="markdown-body" id="markdown-body">
                    <div class="loading">Select a file from the sidebar.</div>
                </article>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked@14/marked.min.js"></script>
    <script>
        // --- State ---
        const state = {
            currentFile: null,
            currentSource: null,
            files: [], tasks: [], lessons: [], adrs: [], features: [],
            hasLessonIndex: false, hasAdrIndex: false,
            theme: localStorage.getItem('mb-theme') || 'light',
        };

        // --- Collapsed sections (persisted) ---
        function getCollapsed() {
            try { return JSON.parse(localStorage.getItem('mb-collapsed') || '{}'); } catch(e) { return {}; }
        }
        function setCollapsed(id, val) {
            var c = getCollapsed(); c[id] = val; localStorage.setItem('mb-collapsed', JSON.stringify(c));
        }
        function isCollapsed(id) { return getCollapsed()[id] === true; }

        // --- Accent Color ---
        var defaultAccents = { light: '#3b82f6', dark: '#60a5fa' };

        function hexToRgb(hex) {
            var r = parseInt(hex.slice(1, 3), 16);
            var g = parseInt(hex.slice(3, 5), 16);
            var b = parseInt(hex.slice(5, 7), 16);
            return { r: r, g: g, b: b };
        }

        function darkenHex(hex, amount) {
            var rgb = hexToRgb(hex);
            var r = Math.max(0, Math.round(rgb.r * (1 - amount)));
            var g = Math.max(0, Math.round(rgb.g * (1 - amount)));
            var b = Math.max(0, Math.round(rgb.b * (1 - amount)));
            return '#' + [r, g, b].map(function(c) { return c.toString(16).padStart(2, '0'); }).join('');
        }

        function applyAccentColor(hex) {
            var rgb = hexToRgb(hex);
            var root = document.documentElement;
            root.style.setProperty('--accent', hex);
            root.style.setProperty('--accent-hover', darkenHex(hex, 0.2));
            root.style.setProperty('--sidebar-active-bg', 'rgba(' + rgb.r + ',' + rgb.g + ',' + rgb.b + ',0.2)');
            document.getElementById('accent-picker').value = hex;
            document.getElementById('color-swatch').style.backgroundColor = hex;
        }

        function getSavedAccent() {
            return localStorage.getItem('mb-accent') || null;
        }

        // --- Init ---
        async function init() {
            applyTheme(state.theme);
            var savedAccent = getSavedAccent();
            if (savedAccent) {
                applyAccentColor(savedAccent);
            } else {
                applyAccentColor(defaultAccents[state.theme]);
            }
            marked.setOptions({ gfm: true, breaks: false });
            await loadManifest();
            buildSidebar();
            if (state.files.length > 0) { loadFile(state.files[0].filename); }
        }
        document.addEventListener('DOMContentLoaded', init);

        // --- API ---
        async function loadManifest() {
            const [filesRes, tasksRes, lessonsRes, adrsRes, featuresRes] = await Promise.all([
                fetch('/api/files').then(function(r) { return r.json(); }),
                fetch('/api/tasks').then(function(r) { return r.json(); }),
                fetch('/api/lessons').then(function(r) { return r.json(); }),
                fetch('/api/adrs').then(function(r) { return r.json(); }),
                fetch('/api/features').then(function(r) { return r.json(); }),
            ]);
            state.files = filesRes.files;
            state.tasks = tasksRes.tasks;
            state.lessons = lessonsRes.lessons;
            state.hasLessonIndex = lessonsRes.has_index;
            state.adrs = adrsRes.adrs;
            state.hasAdrIndex = adrsRes.has_index;
            state.features = featuresRes.features;
        }

        // --- Source-to-API mapping ---
        var sourceApiMap = {
            'memory-bank': '/api/file/',
            'lesson': '/api/lesson/',
            'adr': '/api/adr/',
            'feature': '/api/feature/',
        };

        var sourceLabel = {
            'memory-bank': '',
            'lesson': 'lessons-learned/',
            'adr': 'adrs/',
            'feature': 'features/',
        };

        async function loadFile(filename, source) {
            source = source || 'memory-bank';
            state.currentFile = filename;
            state.currentSource = source;
            updateActiveState();

            var body = document.getElementById('markdown-body');
            var meta = document.getElementById('content-meta');
            body.innerHTML = '<div class="loading">Loading...</div>';
            meta.style.display = 'none';

            try {
                var url = sourceApiMap[source] + encodeURIComponent(filename);
                var res = await fetch(url);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                var data = await res.json();

                body.innerHTML = marked.parse(data.content);

                var date = new Date(data.modified * 1000);
                meta.textContent = sourceLabel[source] + filename + '  \u2014  last modified ' + date.toLocaleString();
                meta.style.display = 'block';

                // Breadcrumb for task detail pages
                if (source === 'memory-bank' && filename.startsWith('tasks/') && filename !== 'tasks/_index.md') {
                    addBreadcrumb(body, 'Tasks Index', function() { loadFile('tasks/_index.md'); },
                        filename.split('/').pop().replace('.md', ''));
                }

                // Breadcrumb for lesson detail pages
                if (source === 'lesson' && filename !== 'lesson-learned-index.md') {
                    if (state.hasLessonIndex) {
                        addBreadcrumb(body, 'Lessons Index', function() { loadFile('lesson-learned-index.md', 'lesson'); },
                            filename.replace('.md', ''));
                    } else {
                        addBreadcrumb(body, null, null, filename.replace('.md', ''), 'Lessons Learned');
                    }
                }

                // Breadcrumb for ADR detail pages
                if (source === 'adr' && filename !== 'README.md') {
                    if (state.hasAdrIndex) {
                        addBreadcrumb(body, 'ADR Index', function() { loadFile('README.md', 'adr'); },
                            filename.replace('.md', ''));
                    } else {
                        addBreadcrumb(body, null, null, filename.replace('.md', ''), 'ADRs');
                    }
                }

                // Linkify references
                if (source === 'memory-bank' && filename === 'tasks/_index.md') linkifyTaskReferences(body);
                if (source === 'lesson' && filename === 'lesson-learned-index.md') linkifyLessonReferences(body);
            } catch (err) {
                body.innerHTML = '<div class="error">Failed to load ' + filename + ': ' + err.message + '</div>';
            }
        }

        function addBreadcrumb(container, linkText, linkClick, suffix, plainPrefix) {
            var bc = document.createElement('div');
            bc.className = 'breadcrumb';
            if (linkText && linkClick) {
                var a = document.createElement('a');
                a.href = '#';
                a.textContent = linkText;
                a.addEventListener('click', function(e) { e.preventDefault(); linkClick(); });
                bc.appendChild(a);
            } else if (plainPrefix) {
                bc.appendChild(document.createTextNode(plainPrefix));
            }
            bc.appendChild(document.createTextNode(' / ' + suffix));
            container.prepend(bc);
        }

        // --- Sidebar ---
        function buildSidebar() {
            var sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = '';

            // Core Files
            addSection(sidebar, 'core', 'Core Files', state.files.length, function(body) {
                state.files.forEach(function(f) {
                    body.appendChild(sidebarItem(f.label, f.filename, 'memory-bank'));
                });
            });

            // Tasks
            addSection(sidebar, 'tasks', 'Tasks', state.tasks.length + 1, function(body) {
                body.appendChild(sidebarItem('Task Index', 'tasks/_index.md', 'memory-bank'));
                state.tasks.forEach(function(t) {
                    body.appendChild(sidebarItem(t.label, t.filename, 'memory-bank', true));
                });
            });

            // Lessons Learned
            var llCount = state.lessons.length + (state.hasLessonIndex ? 1 : 0);
            addSection(sidebar, 'lessons', 'Lessons Learned', llCount, function(body) {
                if (state.hasLessonIndex) {
                    body.appendChild(sidebarItem('Lessons Index', 'lesson-learned-index.md', 'lesson'));
                }
                if (state.lessons.length > 0) {
                    state.lessons.forEach(function(l) {
                        body.appendChild(sidebarItem(l.label, l.filename, 'lesson', true));
                    });
                } else if (!state.hasLessonIndex) {
                    body.appendChild(el('div', 'sidebar-empty', 'No lessons yet'));
                }
            });

            // ADRs
            var adrCount = state.adrs.length + (state.hasAdrIndex ? 1 : 0);
            addSection(sidebar, 'adrs', 'ADRs', adrCount, function(body) {
                if (state.hasAdrIndex) {
                    body.appendChild(sidebarItem('ADR Index', 'README.md', 'adr'));
                }
                if (state.adrs.length > 0) {
                    state.adrs.forEach(function(a) {
                        body.appendChild(sidebarItem(a.label, a.filename, 'adr', true));
                    });
                } else if (!state.hasAdrIndex) {
                    body.appendChild(el('div', 'sidebar-empty', 'No ADRs yet'));
                }
            });

            // Features
            addSection(sidebar, 'features', 'Features', state.features.length, function(body) {
                if (state.features.length > 0) {
                    state.features.forEach(function(f) {
                        body.appendChild(sidebarItem(f.label, f.filename, 'feature', true));
                    });
                } else {
                    body.appendChild(el('div', 'sidebar-empty', 'No features yet'));
                }
            });
        }

        function addSection(sidebar, id, label, count, buildBody) {
            var section = el('div', 'sidebar-section');
            if (isCollapsed(id)) section.classList.add('collapsed');

            // Heading with chevron and count
            var heading = el('div', 'sidebar-heading');
            var labelSpan = document.createElement('span');
            labelSpan.textContent = label;
            if (count > 0) {
                var badge = el('span', 'sidebar-count', String(count));
                labelSpan.appendChild(badge);
            }
            heading.appendChild(labelSpan);
            var chevron = el('span', 'sidebar-chevron', '\u25BE');
            heading.appendChild(chevron);

            heading.addEventListener('click', function() {
                var nowCollapsed = !section.classList.contains('collapsed');
                section.classList.toggle('collapsed');
                setCollapsed(id, nowCollapsed);
            });

            section.appendChild(heading);

            var body = el('div', 'sidebar-body');
            buildBody(body);
            section.appendChild(body);

            sidebar.appendChild(section);
        }

        function sidebarItem(label, filename, source, isSub) {
            var cls = 'sidebar-item' + (isSub ? ' sub-item' : '');
            var item = el('div', cls, label);
            item.dataset.filename = filename;
            item.dataset.source = source;
            item.addEventListener('click', function() { loadFile(filename, source); });
            return item;
        }

        function updateActiveState() {
            document.querySelectorAll('.sidebar-item').forEach(function(item) {
                item.classList.toggle('active',
                    item.dataset.filename === state.currentFile &&
                    item.dataset.source === state.currentSource
                );
            });
        }

        // --- Task linkification ---
        function linkifyTaskReferences(container) {
            var walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
            var nodes = [];
            while (walker.nextNode()) {
                if (/\[TASK\d+\]/.test(walker.currentNode.textContent)) nodes.push(walker.currentNode);
            }
            nodes.forEach(function(node) {
                var html = node.textContent.replace(/\[(TASK\d+)\]/g, function(match, taskId) {
                    var taskFile = state.tasks.find(function(t) { return t.filename.toUpperCase().includes(taskId); });
                    if (taskFile) return '<a href="#" class="task-link" data-filename="' + taskFile.filename + '" data-source="memory-bank">' + match + '</a>';
                    return match;
                });
                var span = document.createElement('span');
                span.innerHTML = html;
                node.parentNode.replaceChild(span, node);
            });
            container.querySelectorAll('.task-link[data-source="memory-bank"]').forEach(function(link) {
                link.addEventListener('click', function(e) { e.preventDefault(); loadFile(link.dataset.filename); });
            });
        }

        // --- Lesson linkification ---
        function linkifyLessonReferences(container) {
            var walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
            var nodes = [];
            while (walker.nextNode()) {
                if (/LL-\d{3}/.test(walker.currentNode.textContent)) nodes.push(walker.currentNode);
            }
            nodes.forEach(function(node) {
                var html = node.textContent.replace(/\b(LL-\d{3})\b/g, function(match, llId) {
                    var lessonFile = state.lessons.find(function(l) { return l.filename.toUpperCase().startsWith(llId.toUpperCase()); });
                    if (lessonFile) return '<a href="#" class="task-link" data-filename="' + lessonFile.filename + '" data-source="lesson">' + match + '</a>';
                    return match;
                });
                var span = document.createElement('span');
                span.innerHTML = html;
                node.parentNode.replaceChild(span, node);
            });
            container.querySelectorAll('.task-link[data-source="lesson"]').forEach(function(link) {
                link.addEventListener('click', function(e) { e.preventDefault(); loadFile(link.dataset.filename, 'lesson'); });
            });
        }

        // --- Theme ---
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('mb-theme', theme);
        }
        document.getElementById('theme-btn').addEventListener('click', function() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            applyTheme(state.theme);
            var savedAccent = getSavedAccent();
            if (!savedAccent) {
                applyAccentColor(defaultAccents[state.theme]);
            }
        });

        // --- Accent picker ---
        document.getElementById('accent-picker').addEventListener('input', function(e) {
            applyAccentColor(e.target.value);
            localStorage.setItem('mb-accent', e.target.value);
        });
        document.getElementById('color-swatch').addEventListener('dblclick', function() {
            localStorage.removeItem('mb-accent');
            applyAccentColor(defaultAccents[state.theme]);
        });

        // --- Refresh ---
        document.getElementById('refresh-btn').addEventListener('click', async function() {
            await loadManifest();
            buildSidebar();
            if (state.currentFile) loadFile(state.currentFile, state.currentSource);
        });

        // --- Auto-refresh (30s) ---
        setInterval(function() {
            if (state.currentFile) loadFile(state.currentFile, state.currentSource);
        }, 30000);

        // --- Helpers ---
        function el(tag, className, text) {
            var e = document.createElement(tag);
            if (className) e.className = className;
            if (text) e.textContent = text;
            return e;
        }
    </script>
</body>
</html>
